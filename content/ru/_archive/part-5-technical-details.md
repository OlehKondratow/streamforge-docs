+++
date = '2025-08-24T20:26:06+02:00'
draft = false
title = 'Технические детали'
weight = 5
+++

## Часть V: Технические детали и приложения

В этом разделе представлены подробные технические спецификации, примеры конфигурации и руководства по эксплуатации, предназначенные для углубленного изучения архитектуры и реализации платформы StreamForge.

### Приложение A: Схемы данных и API

В этом приложении представлена полная техническая спецификация API `queue-manager`, включая подробные схемы JSON для всех типов сообщений, которыми обмениваются через Apache Kafka. Эта информация необходима разработчикам и системным архитекторам, которым требуется всестороннее понимание внутренних структур данных и взаимодействия компонентов.

### Приложение B: Примеры манифестов Kubernetes

Это приложение содержит примеры манифестов Kubernetes, которые иллюстрируют развертывание и настройку различных компонентов StreamForge в кластере.

#### Пример: Задание Kubernetes для `arango-candles`

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: job-arango-candles-btcusdt-abc123
  namespace: stf
  labels:
    app: streamforge
    queue_id: "wf-btcusdt-api_candles_1m-20240801-abc123"
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: arango-candles
          image: registry.dmz.home/streamforge/arango-candles:v0.1.5
          env:
            - name: QUEUE_ID
              value: "wf-btcusdt-api_candles_1m-20240801-abc123"
            - name: SYMBOL
              value: "BTCUSDT"
            - name: TYPE
              value: "api_candles_1m"
            - name: KAFKA_TOPIC
              value: "wf-btcusdt-api_candles_1m-20240801-abc123-data"
            - name: COLLECTION_NAME
              value: "btcusdt_api_candles_1m_2024_08_01"
            # ... другие переменные из ConfigMap и Secret ...
      nodeSelector:
        streamforge-worker: "true" # Пример селектора для выделенных узлов
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600
```

### Приложение C: Детали конвейера CI/CD и лучшие практики

В этом приложении подробно описаны стандартизированные процессы CI/CD, реализованные на платформе StreamForge, с упором на лучшие практики, применяемые для эффективной и последовательной разработки, сборки и развертывания микросервисов.

**Ключевые принципы и реализации:**

*   **Единый базовый образ для сервисов и тестов:** Единый, всеобъемлющий базовый образ Docker (`registry.dmz.home/kinga/stream-forge/base:latest`, созданный из `platform/Dockerfile`) используется для всех сервисов Python как для выполнения приложений, так и для тестирования. Этот образ предварительно устанавливает общие зависимости Python, включая все необходимые тестовые фреймворки (например, `pytest`, `httpx`, `python-arango`), и интегрирует библиотеку `streamforge_utils` посредством надежной установки wheel. Такой подход обеспечивает согласованность среды, сокращает время сборки и упрощает управление зависимостями.

*   **Оптимизированные сборки Kaniko:** Сборки образов контейнеров используют `kaniko` для безопасных операций без демона непосредственно в кластере Kubernetes. Процессы сборки оптимизированы за счет:
    *   Использования корневого каталога проекта (`$CI_PROJECT_DIR`) в качестве контекста сборки, что позволяет Docker-файлам эффективно получать доступ к общим библиотекам и ресурсам в репозитории.
    *   Реализации явного кэширования слоев образа (`--cache=true --cache-repo "$CI_REGISTRY_IMAGE/cache"`) для значительного ускорения последующих сборок за счет повторного использования неизмененных слоев.

*   **Оптимизированное тестирование:** Модульные и интеграционные тесты выполняются в едином базовом образе, что позволяет использовать предварительно установленные тестовые зависимости. Это устраняет избыточную установку зависимостей во время выполнения конвейера, что приводит к более быстрым и надежным циклам тестирования.

*   **Модульная конфигурация CI/CD:** Конфигурация CI/CD структурирована с использованием общих шаблонов (например, `.build_python_service` в `.gitlab/ci-templates/Python-Service.gitlab-ci.yml`), которые расширяются конкретными конвейерами для каждого микросервиса. Такая модульность способствует повторному использованию, упрощает обслуживание и обеспечивает последовательное применение лучших практик CI/CD на всей платформе.


### Приложение D: Глоссарий терминов

Этот глоссарий содержит определения ключевых терминов и понятий, используемых в документации StreamForge, включая такие термины, как рабочий процесс, задание, разделение и идемпотентность, для обеспечения последовательного и технически точного понимания.

### Приложение E: Руководство по развертыванию и эксплуатации

Это руководство содержит пошаговые инструкции по развертыванию платформы StreamForge с нуля, а также рекомендации по передовым практикам мониторинга, процедурам резервного копирования и обновлениям системы, обеспечивая комплексное управление жизненным циклом.

### Приложение F: Процедура тестирования

Функциональное и интеграционное тестирование системы StreamForge облегчается набором специализированных инструментов, включая `dummy-service` и `debug_producer.py`. Эти утилиты наиболее эффективно используются в стандартизированной среде разработки `devcontainer`.

**1. `dummy-service`: диагностический и симуляционный микросервис**

`dummy-service` предназначен для имитации поведения различных сервисов, проверки подключения к Apache Kafka и имитации различных сценариев нагрузки.

*   **Запуск:** Сервис можно запустить в Kubernetes как `Job` или `Pod`. Для локального тестирования в `devcontainer` используется следующая команда:
    ```bash
    python3.11 -m app.main --debug --simulate-loading
    ```
*   **Дополнительная информация:** Подробное описание доступно в `services/dummy-service/README.md`.

**2. `debug_producer.py`: CLI для внедрения команд и проверки ответов**

Этот инструмент CLI используется для отправки тестовых команд (`ping`, `stop`) в Apache Kafka и последующей проверки полученных ответов.

*   **Тестирование подключения к Kafka (ping/pong):**
    ```bash
    python3.11 services/dummy-service/debug_producer.py \
      --queue-id <your-queue-id> \
      --command ping \
      --expect-pong
    ```
*   **Тестирование команды остановки (stop):**
    ```bash
    python3.11 services/dummy-service/debug_producer.py \
      --queue-id <your-queue-id> \
      --command stop
    ```
*   **Тестирование имитации нагрузки и отслеживания состояния:** Запуск `dummy-service` с флагом `--simulate-loading` позволяет отслеживать события в теме `queue-events`.

*   **Тестирование имитации сбоев:** Запуск `dummy-service` с параметром `--fail-after N` позволяет наблюдать за отправкой событий `error`.
*   **Тестирование метрик Prometheus:** Метрики проверяются с помощью `curl localhost:8000/metrics`.

**3. `devcontainer`: стандартизированная среда разработки**

Спецификация `devcontainer` используется для предоставления полной, автономной среды разработки в контейнере Docker, тесно интегрированной с VS Code. Такой подход гарантирует согласованную и воспроизводимую среду для всех разработчиков проекта.

**Ключевые особенности:**
*   **Базовый образ:** Ubuntu 22.04 LTS.
*   **Инструменты:** Включает предварительно установленные инструменты, такие как `kubectl`, Helm, `gitlab-runner`, `git`, `curl`, `ssh` и другие.
*   **Доступ к Kubernetes:** Автоматическая настройка доступа к кластеру Kubernetes.
*   **Пользователи и SSH:** Создание отдельного пользователя и настройка доступа по SSH.
*   **Сертификаты:** Установка сертификатов ЦС для обеспечения доверия к внутренним сервисам.

**Инструкции по использованию:**
1.  Установите Docker Desktop и расширение «Dev Containers» для VS Code.
2.  Откройте проект StreamForge в VS Code и выберите «Reopen in Container».
3.  VS Code автоматически соберет образ и запустит контейнер.

### Приложение G: Управление ресурсами Kafka

Манифесты Kubernetes, расположенные в каталоге `cred-kafka-yaml/`, используются для декларативного управления ресурсами Apache Kafka через оператор Strimzi. Это включает создание тем (`queue-control`, `queue-events`), управление пользователями Kafka (`user-streamforge`) и их списками контроля доступа (ACL), а также безопасное управление учетными данными через секреты Kubernetes.

### Приложение H: Среда отладки Kubernetes

Для отладки в кластере и интерактивных сеансов StreamForge использует следующие инструменты и методологии:

*   **JupyterHub:** Обеспечивает предоставление по требованию интерактивных сеансов Jupyter Notebook непосредственно в кластере Kubernetes. Образы контейнеров, используемые для этих сеансов, предварительно настроены с основными инструментами командной строки, включая `kubectl` и `helm`.

    **Ключевые особенности настройки JupyterHub:**
    *   **Управление простаивающими серверами:** Автоматическое завершение простаивающих серверов Jupyter для оптимизации использования ресурсов.
    *   **Аутентификация:** Для тестовой среды используется простая «фиктивная» аутентификация.
    *   **Базовая база данных:** Используется `sqlite-memory`, но данные сохраняются на хосте.
    *   **Размещение модулей:** Серверы Hub и пользовательские серверы запускаются на узле `k2w-8`.
    *   **Доступ:** Через Ingress по адресу `jupyterhub.dmz.home` с TLS.
    *   **Образы пользовательских серверов:** Используется настраиваемый образ `registry.dmz.home/streamforge/core-modules/jupyter-python311:v0.0.2` с необходимыми инструментами.
    *   **Ресурсы:** Гарантированное выделение памяти для каждого сервера — `1G`.
    *   **Хранение данных:** Для `/home/`, `/data/project`, `/data/venv` используются постоянные тома, смонтированные с хоста.
    *   **Безопасность:** Модули запускаются с `UID: 1001` и `FSGID: 100`.
    *   **Реестр Docker:** Для аутентификации используется секрет `regcred`.

*   **Dev Container (VS Code):** Подробно описан в Приложении F.

*   **Отладочный контейнер общего назначения:** Поддерживается образ Docker общего назначения, содержащий широкий спектр инструментов (`kubectl`, `helm`, `kafkacat`, `python`). Этот образ можно развернуть как эфемерный модуль (`kubectl run -it ...`) для интерактивной отладки и административных задач непосредственно в кластере.